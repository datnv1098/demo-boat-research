name: Deploy to EC2

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # Cho phép trigger thủ công

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build application
      run: npm run build
      
    - name: Create deployment package
      run: |
        # Tạo server.js cho production
        cat > server.js << 'EOF'
        const express = require('express');
        const path = require('path');
        const app = express();
        const port = process.env.PORT || 3000;

        // Serve static files
        app.use(express.static(path.join(__dirname, 'dist')));

        // Handle React Router
        app.get('*', (req, res) => {
          res.sendFile(path.join(__dirname, 'dist', 'index.html'));
        });

        app.listen(port, () => {
          console.log(`Server running on port ${port}`);
        });
        EOF
        
        # Tạo package.json cho production
        cat > package-prod.json << 'EOF'
        {
          "name": "fisheries-demo",
          "version": "1.0.0",
          "main": "server.js",
          "scripts": {
            "start": "node server.js"
          },
          "dependencies": {
            "express": "^4.18.2"
          }
        }
        EOF
        
        # Tạo ecosystem config cho PM2
        cat > ecosystem.config.js << 'EOF'
        module.exports = {
          apps: [{
            name: 'fisheries-demo',
            script: './server.js',
            instances: 1,
            autorestart: true,
            watch: false,
            max_memory_restart: '1G',
            env: {
              NODE_ENV: 'production',
              PORT: 3000
            }
          }]
        };
        EOF
        
        # Package everything
        zip -r deploy.zip dist/ server.js package-prod.json ecosystem.config.js
        
    - name: Test SSH Connection
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_PORT || 22 }}
        timeout: 30s
        command_timeout: 10m
        script: |
          echo "SSH connection successful!"
          whoami
          pwd
          
    - name: Upload deployment package
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_PORT || 22 }}
        timeout: 30s
        command_timeout: 10m
        source: "deploy.zip"
        target: "/tmp/"
        
    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_PORT || 22 }}
        script: |
          set -e  # Exit on error
          
          echo "=== Starting Deployment ==="
          
          # Setup directories
          sudo mkdir -p /var/www/fisheries-demo
          cd /var/www/fisheries-demo
          
          # Backup existing deployment
          if [ -d "dist" ]; then
            echo "Backing up existing deployment..."
            sudo rm -rf dist.backup
            sudo mv dist dist.backup
          fi
          
          # Extract new deployment
          echo "Extracting new deployment..."
          sudo unzip -o /tmp/deploy.zip
          sudo mv package-prod.json package.json
          
          # Install Node.js if not present
          if ! command -v node &> /dev/null; then
            echo "Installing Node.js..."
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
          fi
          
          # Install PM2 if not present
          if ! command -v pm2 &> /dev/null; then
            echo "Installing PM2..."
            sudo npm install -g pm2
          fi
          
          # Install dependencies
          echo "Installing dependencies..."
          sudo npm install --production
          
          # Set permissions
          sudo chown -R $USER:$USER /var/www/fisheries-demo
          sudo chmod -R 755 /var/www/fisheries-demo
          
          # Restart application with PM2
          echo "Restarting application..."
          pm2 delete fisheries-demo 2>/dev/null || true
          pm2 start ecosystem.config.js
          pm2 save
          
          # Setup PM2 startup
          sudo env PATH=$PATH:/usr/bin pm2 startup systemd -u $USER --hp /home/$USER
          
          # Install and configure Nginx if not present
          if ! command -v nginx &> /dev/null; then
            echo "Installing Nginx..."
            sudo apt-get update
            sudo apt-get install -y nginx
          fi
          
          # Configure Nginx
          echo "Configuring Nginx..."
          sudo tee /etc/nginx/sites-available/fisheries-demo > /dev/null << 'NGINX_EOF'
          server {
              listen 80;
              server_name _;
              
              location / {
                  proxy_pass http://localhost:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_cache_bypass $http_upgrade;
              }
          }
          NGINX_EOF
          
          # Enable site
          sudo ln -sf /etc/nginx/sites-available/fisheries-demo /etc/nginx/sites-enabled/
          sudo rm -f /etc/nginx/sites-enabled/default
          
          # Test and reload Nginx
          sudo nginx -t && sudo systemctl reload nginx
          sudo systemctl enable nginx
          
          # Cleanup
          sudo rm -f /tmp/deploy.zip
          
          echo "=== Deployment completed successfully! ==="
          echo "Application is running at: http://${{ secrets.EC2_HOST }}"
          pm2 status
